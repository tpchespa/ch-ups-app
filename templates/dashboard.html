<!DOCTYPE html>
<html>
<head>
  <title>UPS Full Form</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css">
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
</head>
<body>
  <header>
    <div>Welcome, {{ current_user.email }}</div>
    <a href="/logout">Logout</a>
  </header>

<div class="dashboard-wrapper">

    <div class="container">
      <h2>UPS Shipment Form</h2>
      <form id="form" class="form-wrapper" autocomplete="off">
        <div class="form-submit form-actions-row">
          <button type="submit">Submit</button>

            <label class="save-contact-label">
              <input type="checkbox" id="saveContactCheckbox" />
              Save contact
            </label>
          </div>
          <div class="contact-search-row">
            <label for="contactSearch" class="contact-label">Load saved contact:</label>
            <input id="contactSearch" list="contactList" placeholder="Start typing..." autocomplete="off" class="contact-dropdown" />
            <datalist id="contactList"></datalist>
            <a href="/contacts/manage" class="tiny-manage-button" title="Manage saved contacts">⚙️</a>
          </div>
        <div class="horizontal-form">
        <div class="horizontal-field">
          <label for="Contact_Name" class="label-with-tooltip">
            Contact Name
          <span class="tooltip-icon">
            <i class="fas fa-circle-question"></i>
            <span class="tooltip-content">
              First and last name of recipient.
              Required for international/export shipments or UPS Next Day Air Early AM service.
              Field Type: Alphanumeric, Maximum Characters: 35, Required: Conditional.
            </span>
          </span>
          </label>
          <input type="text" id="Contact_Name" name="con-na-custom" autocomplete="off">
          <div class="field-error" id="error-Contact_Name"></div>
        </div>

        <div class="horizontal-field">
          <label for="Company_or_Name" class="label-with-tooltip">
            Company or Name
          <span class="tooltip-icon">
            <i class="fas fa-circle-question"></i>
            <span class="tooltip-content">
              Company name of recipient (or First and Last name of recipient if company is not applicable).
              Field Type: Alphanumeric, Maximum Characters: 35, Required: Yes.
            </span>
          </span>
          </label>
          <input type="text" id="Company_or_Name" autocomplete="off">
          <div class="field-error" id="error-Company_or_Name"></div>
        </div>

        <div class="horizontal-field">
          <label for="Country" class="label-with-tooltip">
            Country
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Recipient's country; only ISO Alpha-2 codes are accepted.
                (e.g.: US=United States,JP=Japan, DE=Germany,etc.)
                Field Type: Alphanumeric, Maximum Characters: 2, Required: Yes.
              </span>
            </span>
          </label>
          <div class="input-wrapper">
            <input type="text" id="Country" autocomplete="off">
          </div>
          <div class="field-error" id="error-Country"></div>
        </div>

        <div class="horizontal-field">
          <label for="Address_1" class="label-with-tooltip">
            Address 1
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Address 1 for recipient.
                Field Type: Alphanumeric, Maximum Characters: 35, Required: Yes.
              </span>
            </span>

          </label>
          <input type="text" id="Address_1" autocomplete="off">
          <div class="field-error" id="error-Address_1"></div>
        </div>

        <div class="horizontal-field">
          <label for="City" class="label-with-tooltip">
            City
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Recipient's city
                Field Type: Alphanumeric, Maximum Characters: 30, Required: Yes.
              </span>
            </span>
          </label>
          <input type="text" id="City" autocomplete="off">
          <div class="field-error" id="error-City"></div>
        </div>

        <div class="horizontal-field">
          <label for="State_Prov_Other" class="label-with-tooltip">
          State/Prov/Other
          <span class="tooltip-icon">
            <i class="fas fa-circle-question"></i>
            <span class="tooltip-content">
              Recipient's State or Province, if applicable
              Required for certain destination countries
              Field Type: Alphanumeric, Maximum Characters: 30, Required: Conditional.
            </span>
          </span>

          </label>
          <input type="text" id="State_Prov_Other" autocomplete="off">
          <div class="field-error" id="error-State_Prov_Other"></div>
        </div>

        <div class="horizontal-field">
          <label for="Postal_Code">Postal Code</label>
          <input type="text" id="Postal_Code" autocomplete="off">
          <div class="field-error" id="error-Postal_Code"></div>
        </div>

        <div class="horizontal-field">
          <label for="Telephone">Telephone</label>
          <input type="text" id="Telephone" autocomplete="off">
          <div class="field-error" id="error-Telephone"></div>
        </div>

        <div class="horizontal-field">
          <label for="Consignee_Email">Consignee Email</label>
          <input type="text" id="Consignee_Email" autocomplete="off">
        </div>

        <div class="horizontal-field">
          <label for="Packaging_Type" class="label-with-tooltip">
            Packaging Type
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
              UPS packaging code (e.g. 01 = Envelope, 2 = Customer Packaging)
              Field Type: Alphanumeric, Maximum Characters: 2, Required: Yes.
              </span>
            </span>
          </label>
          <div class="input-wrapper">
            <input type="text" id="Packaging_Type" autocomplete="off">
          </div>
          <div class="field-error" id="error-Packaging_Type"></div>
        </div>

        <div class="horizontal-field">
          <label for="Weight" class="label-with-tooltip">
            Weight
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Required for a packaging type 2 (Other Packaging/Customer Packaging). Optional for packaging type 1 (UPS Letter/Envelope).
                Field Type: Numeric, Maximum Characters: 5, Required: Conditional.
              </span>
            </span>
          </label>
          <input type="text" id="Weight" autocomplete="off">
          <div class="field-error" id="error-Weight"></div>
        </div>

        <div class="horizontal-field">
          <label for="Length" class="label-with-tooltip">
            Length
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Defaults to inches for U.S./PR; centimeters everywhere else. CA has choice between inches and centimeters.
                Field Type: Numeric, Maximum Characters: 4, Required: No.
              </span>
            </span>
          </label>
          <input type="text" id="Length" autocomplete="off">
          <div class="field-error" id="error-Length"></div>
        </div>

        <div class="horizontal-field">
          <label for="Width">
            Width
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Defaults to inches for U.S./PR; centimeters everywhere else. CA has choice between inches and centimeters.
                Field Type: Numeric, Maximum Characters: 4, Required: No.
              </span>
            </span>
          </label>
          <input type="text" id="Width" autocomplete="off">
          <div class="field-error" id="error-Width"></div>
        </div>

        <div class="horizontal-field">
          <label for="Height">
            Height
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">
                Defaults to inches for U.S./PR; centimeters everywhere else. CA has choice between inches and centimeters.
                Field Type: Numeric, Maximum Characters: 4, Required: No.
              </span>
            </span>
          </label>
          <input type="text" id="Height" autocomplete="off">
          <div class="field-error" id="error-Height"></div>
        </div>

        <div class="horizontal-field">
          <label for="Description_of_Goods">Description of Goods</label>
          <input type="text" id="Description_of_Goods" autocomplete="off">
          <div class="field-error" id="error-Description_of_Goods"></div>
        </div>

        <div class="horizontal-field">
          <label for="Documents_of_No_Commercial_Value" class="label-with-tooltip">
            Documents of No Commercial Value
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">Indicates the shipment does not contain any dutiable items</span>
            </span>
          </label>
          <select id="Documents_of_No_Commercial_Value">
            <option value="">--</option>
            <option value="1">1</option>
          </select>
        </div>

        <div class="horizontal-field">
          <label for="Service" class="label-with-tooltip">
            Service
            <span class="tooltip-icon">
              <i class="fas fa-circle-question"></i>
              <span class="tooltip-content">UPS service code (e.g. 65 = Saver, 07 = Express)</span>
            </span>
          </label>
          <div class="input-wrapper">
            <input type="text" id="Service" autocomplete="off">
          </div>
          <div class="field-error" id="error-Service"></div>
        </div>

        <div class="horizontal-field">
          <label for="Reference_1">Kod klienta</label>
          <input type="text" id="Reference_1" autocomplete="off"> 
          <div class="field-error" id="error-Reference_1"></div>
        </div>

        <div class="horizontal-field">
          <label for="Reference_2">Kod handlowca</label>
          <input type="text" id="Reference_2" autocomplete="off">
          <div class="field-error" id="error-Reference_2"></div>
        </div>

        <!-- Custom Non-CSV Fields -->
        <div class="horizontal-field">
          <label for="Custom_Order_Number">Nr zamówienia gdzie będzie doliczony koszt</label>
          <input type="text" id="Custom_Order_Number">
        </div>

        <div class="horizontal-field">
          <label for="Custom_Project_Number">Nr projektu</label>
          <input type="text" id="Custom_Project_Number">
        </div>

        <div class="horizontal-field">
          <label for="Custom_UPS_Number">Nr listu UPS</label>
          <input type="text" id="Custom_UPS_Number">
        </div>

        <div class="horizontal-field">
          <label for="Custom_Cost">Koszt (Logistyka))</label>
          <input type="text" id="Custom_Cost">
        </div>

        <div class="horizontal-field">
          <label for="Custom_Ship_Date">Data wysyłki</label>
          <input type="date" id="Custom_Ship_Date">
        </div>
      </div>
      </form>
    </div>

<div class="submissions-section">
  <h3>Submitted Shipments</h3>
  <div class="submission-controls">
    <div style="display: inline-flex; gap: 12px; align-items: center; padding: 10px 16px; border-radius: 8px; background-color: #1e1e1e; border: 1px solid #333;">
      <label for="view-mode" class="label-inline">View by:</label>
      <select id="view-mode" class="small-input">
        <option value="date" selected>Day</option>
        <option value="month">Month</option>
      </select>
      <input id="unified-picker" class="date-input small-input">
    </div>

  <a href="/download{% if selected_date %}?date={{ selected_date }}{% elif selected_month %}?month={{ selected_month }}{% endif %}" class="button-link">Download CSV file</a>
  <a href="/download_xlsx{% if selected_date %}?date={{ selected_date }}{% elif selected_month %}?month={{ selected_month }}{% endif %}" class="button-link xlsx-button">
    <i class="fas fa-file-excel" style="margin-right: 6px;"></i>
    Download XLSX file
  </a>
  </div>
  <h4>
    {% if selected_month %}
      Showing entries for {{ selected_month }}
    {% elif selected_date %}
      Showing entries for {{ selected_date }}
    {% endif %}
  </h4>
  <table id="horizontal-table">
    <thead>
      <tr>
        <th></th>
        <th>Time</th><th>User</th>
        <th>Contact Name</th><th>Company or Name</th><th>Country</th><th>Address 1</th><th>City</th>
        <th>State/Prov/Other</th><th>Postal Code</th><th>Telephone</th><th>Consignee Email</th><th>Packaging Type</th><th>Weight</th>
        <th>Length</th><th>Width</th><th>Height</th><th>Description of Goods</th><th>Docs No Value</th><th>Service</th>
        <th>Kod klienta</th><th>Kod handlowca</th>
        <th>nr zam.</th><th>NR PROJEKTU</th><th>NR LISTU UPS</th><th>KOSZT</th><th>DATA WYSYŁKI</th>
      </tr>
    </thead>
    {% for entry in entries %}
    <tr data-id="{{ entry.id }}" data-json='{{ entry.data | tojson }}'>
      {% set ts = entry.data["_submitted_at"] %}
      {% set entry_date = ts[:10] if ts else "" %}

      <td>
        {% if (entry.data["_submitted_by"] == current_email and entry_date == today) or current_user.is_admin %}
          <button class="tiny-delete" onclick="deleteEntry('{{ entry.id }}')">✖</button>
        {% else %}
          &mdash;
        {% endif %}
      </td>
      {% set ts = entry.data["_submitted_at"] %}
      <td data-ts="{{ ts }}"></td>
      <td>{{ entry.data["_submitted_by"] | default("?") }}</td>
      <td>{{ entry.data["Contact Name"] }}</td>
      <td>{{ entry.data["Company or Name"] }}</td>
      <td>{{ entry.data["Country"] }}</td>
      <td>{{ entry.data["Address 1"] }}</td>
      <td>{{ entry.data["City"] }}</td>
      <td>{{ entry.data["State/Prov/Other"] }}</td>
      <td>{{ entry.data["Postal Code"] }}</td>
      <td>{{ entry.data["Telephone"] }}</td>
      <td>{{ entry.data["Consignee Email"] }}</td>
      <td>{{ entry.data["Packaging Type"] }}</td>
      <td>{{ entry.data["Weight"] }}</td>
      <td>{{ entry.data["Length"] }}</td>
      <td>{{ entry.data["Width"] }}</td>
      <td>{{ entry.data["Height"] }}</td>
      <td>{{ entry.data["Description of Goods"] }}</td>
      <td>{{ entry.data["Documents of No Commercial Value"] }}</td>
      <td>{{ entry.data["Service"] }}</td>
      <td>{{ entry.data["Reference 1"] }}</td>
      <td>{{ entry.data["Reference 2"] }}</td>
      <td>{{ entry.data["nr zamówienia gdzie będzie doliczony koszt"] }}</td>
      <td>{{ entry.data["NR PROJEKTU"] }}</td>
      <td>{{ entry.data["NR LISTU UPS"] }}</td>
      <td>{{ entry.data["KOSZT (LOGISTYKA)"] }}</td>
      <td>{{ entry.data["DATA WYSYŁKI"] }}</td>
    </tr>
    {% endfor %}
    <tbody id="submission-body">
    </tbody>
  </table>
  </div>
</div>


<div class="form-errors-wrapper">
  <div id="form-errors" class="error-box" style="display: none;"></div>
</div>

</div>

<script>

const SwalWithDarkTheme = Swal.mixin({
  customClass: {
    popup: 'swal2-popup'
  }
});

let socket;

const countryMap = {
 "AD": "Andorra",
  "AE": "United Arab Emirates",
  "AF": "Afghanistan",
  "AG": "Antigua and Barbuda",
  "AI": "Anguilla",
  "AL": "Albania",
  "AM": "Armenia",
  "AO": "Angola",
  "AQ": "Antarctica",
  "AR": "Argentina",
  "AS": "American Samoa",
  "AT": "Austria",
  "AU": "Australia",
  "AW": "Aruba",
  "AX": "Åland Islands",
  "AZ": "Azerbaijan",
  "BA": "Bosnia and Herzegovina",
  "BB": "Barbados",
  "BD": "Bangladesh",
  "BE": "Belgium",
  "BF": "Burkina Faso",
  "BG": "Bulgaria",
  "BH": "Bahrain",
  "BI": "Burundi",
  "BJ": "Benin",
  "BL": "Saint Barthélemy",
  "BM": "Bermuda",
  "BN": "Brunei Darussalam",
  "BO": "Bolivia (Plurinational State of)",
  "BQ": "Bonaire, Sint Eustatius and Saba",
  "BR": "Brazil",
  "BS": "Bahamas",
  "BT": "Bhutan",
  "BV": "Bouvet Island",
  "BW": "Botswana",
  "BY": "Belarus",
  "BZ": "Belize",
  "CA": "Canada",
  "CC": "Cocos (Keeling) Islands",
  "CD": "Congo (Democratic Republic of the)",
  "CF": "Central African Republic",
  "CG": "Congo",
  "CH": "Switzerland",
  "CI": "Côte d'Ivoire",
  "CK": "Cook Islands",
  "CL": "Chile",
  "CM": "Cameroon",
  "CN": "China",
  "CO": "Colombia",
  "CR": "Costa Rica",
  "CU": "Cuba",
  "CV": "Cabo Verde",
  "CW": "Curaçao",
  "CX": "Christmas Island",
  "CY": "Cyprus",
  "CZ": "Czechia",
  "DE": "Germany",
  "DJ": "Djibouti",
  "DK": "Denmark",
  "DM": "Dominica",
  "DO": "Dominican Republic",
  "DZ": "Algeria",
  "EC": "Ecuador",
  "EE": "Estonia",
  "EG": "Egypt",
  "EH": "Western Sahara",
  "ER": "Eritrea",
  "ES": "Spain",
  "ET": "Ethiopia",
  "FI": "Finland",
  "FJ": "Fiji",
  "FM": "Micronesia (Federated States of)",
  "FO": "Faroe Islands",
  "FR": "France",
  "GA": "Gabon",
  "GB": "United Kingdom of Great Britain and Northern Ireland",
  "GD": "Grenada",
  "GE": "Georgia",
  "GF": "French Guiana",
  "GG": "Guernsey",
  "GH": "Ghana",
  "GI": "Gibraltar",
  "GL": "Greenland",
  "GM": "Gambia",
  "GN": "Guinea",
  "GP": "Guadeloupe",
  "GQ": "Equatorial Guinea",
  "GR": "Greece",
  "GT": "Guatemala",
  "GU": "Guam",
  "GW": "Guinea-Bissau",
  "GY": "Guyana",
  "HK": "Hong Kong",
  "HM": "Heard Island and McDonald Islands",
  "HN": "Honduras",
  "HR": "Croatia",
  "HT": "Haiti",
  "HU": "Hungary",
  "ID": "Indonesia",
  "IE": "Ireland",
  "IL": "Israel",
  "IM": "Isle of Man",
  "IN": "India",
  "IO": "British Indian Ocean Territory",
  "IQ": "Iraq",
  "IR": "Iran (Islamic Republic of)",
  "IS": "Iceland",
  "IT": "Italy",
  "JE": "Jersey",
  "JM": "Jamaica",
  "JO": "Jordan",
  "JP": "Japan",
  "KE": "Kenya",
  "KG": "Kyrgyzstan",
  "KH": "Cambodia",
  "KI": "Kiribati",
  "KM": "Comoros",
  "KN": "Saint Kitts and Nevis",
  "KP": "Korea (Democratic People's Republic of)",
  "KR": "Korea (Republic of)",
  "KW": "Kuwait",
  "KY": "Cayman Islands",
  "KZ": "Kazakhstan",
  "LA": "Lao People's Democratic Republic",
  "LB": "Lebanon",
  "LC": "Saint Lucia",
  "LI": "Liechtenstein",
  "LK": "Sri Lanka",
  "LR": "Liberia",
  "LS": "Lesotho",
  "LT": "Lithuania",
  "LU": "Luxembourg",
  "LV": "Latvia",
  "LY": "Libya",
  "MA": "Morocco",
  "MC": "Monaco",
  "MD": "Moldova (Republic of)",
  "ME": "Montenegro",
  "MF": "Saint Martin (French part)",
  "MG": "Madagascar",
  "MH": "Marshall Islands",
  "MK": "North Macedonia",
  "ML": "Mali",
  "MM": "Myanmar",
  "MN": "Mongolia",
  "MO": "Macao",
  "MP": "Northern Mariana Islands",
  "MQ": "Martinique",
  "MR": "Mauritania",
  "MS": "Montserrat",
  "MT": "Malta",
  "MU": "Mauritius",
  "MV": "Maldives",
  "MW": "Malawi",
  "MX": "Mexico",
  "MY": "Malaysia",
  "MZ": "Mozambique",
  "NA": "Namibia",
  "NC": "New Caledonia",
  "NE": "Niger",
  "NF": "Norfolk Island",
  "NG": "Nigeria",
  "NI": "Nicaragua",
  "NL": "Netherlands",
  "NO": "Norway",
  "NP": "Nepal",
  "NR": "Nauru",
  "NU": "Niue",
  "NZ": "New Zealand",
  "OM": "Oman",
  "PA": "Panama",
  "PE": "Peru",
  "PF": "French Polynesia",
  "PG": "Papua New Guinea",
  "PH": "Philippines",
  "PK": "Pakistan",
  "PL": "Poland",
  "PM": "Saint Pierre and Miquelon",
  "PN": "Pitcairn",
  "PR": "Puerto Rico",
  "PT": "Portugal",
  "PW": "Palau",
  "PY": "Paraguay",
  "QA": "Qatar",
  "RE": "Réunion",
  "RO": "Romania",
  "RS": "Serbia",
  "RU": "Russian Federation",
  "RW": "Rwanda",
  "SA": "Saudi Arabia",
  "SB": "Solomon Islands",
  "SC": "Seychelles",
  "SD": "Sudan",
  "SE": "Sweden",
  "SG": "Singapore",
  "SH": "Saint Helena, Ascension and Tristan da Cunha",
  "SI": "Slovenia",
  "SJ": "Svalbard and Jan Mayen",
  "SK": "Slovakia",
  "SL": "Sierra Leone",
  "SM": "San Marino",
  "SN": "Senegal",
  "SO": "Somalia",
  "SR": "Suriname",
  "SS": "South Sudan",
  "ST": "Sao Tome and Principe",
  "SV": "El Salvador",
  "SX": "Sint Maarten (Dutch part)",
  "SY": "Syrian Arab Republic",
  "SZ": "Eswatini",
  "TC": "Turks and Caicos Islands",
  "TD": "Chad",
  "TF": "French Southern Territories",
  "TG": "Togo",
  "TH": "Thailand",
  "TJ": "Tajikistan",
  "TK": "Tokelau",
  "TL": "Timor-Leste",
  "TM": "Turkmenistan",
  "TN": "Tunisia",
  "TO": "Tonga",
  "TR": "Türkiye",
  "TT": "Trinidad and Tobago",
  "TV": "Tuvalu",
  "TZ": "Tanzania, United Republic of",
  "UA": "Ukraine",
  "UG": "Uganda",
  "UM": "United States Minor Outlying Islands",
  "US": "United States of America",
  "UY": "Uruguay",
  "UZ": "Uzbekistan",
  "VA": "Holy See",
  "VC": "Saint Vincent and the Grenadines",
  "VE": "Venezuela (Bolivarian Republic of)",
  "VG": "Virgin Islands (British)",
  "VI": "Virgin Islands (U.S.)",
  "VN": "Viet Nam",
  "VU": "Vanuatu",
  "WF": "Wallis and Futuna",
  "WS": "Samoa",
  "YE": "Yemen",
  "ZA": "South Africa",
  "ZM": "Zambia",
  "ZW": "Zimbabwe"
};

const residentialMap = {
  "1": "Residential",
  "0": "Commercial"
};

const deliveryConfirmationMap = {
  "S": "Signature Required",
  "N": "Delivery Confirmation with No Signature",
  "A": "Adult Signature Required",
  "V": "Verbal Confirmation"
};

const ADLdeliverToAddresseeMap = {
  "0": "Option not requested", 
  "1": "Deliver To address only option requested"
};

const ADLmediaType = {
  "01": "Voice",
  "03": "Email",
  "12": "SMS Text"
};

const packagingMap = {
  "1": "UPS Letter/Envelope",
  "4": "UPS PAK",
  "3": "UPS Tube",
  "S": "UPS Express Box (Small)",
  "M": "UPS Express Box (Medium)",
  "L": "UPS Express Box (Large)",
  "21": "UPS Box",
  "25": "UPS 10 KG Box",
  "24": "UPS 25 KG Box",
  "2": "Other Packaging/Customer Packaging",
  "30": "Pallet (valid only for PL to PL)"
};

const serviceMap = {
  "01": "Next Day Air",
  "02": "2nd Day Air",
  "03": "Ground",
  "07": "International Express",
  "08": "International Expedited",
  "11": "International Standard",
  "12": "3 Day Select",
  "13": "Next Day Air Saver",
  "14": "Next Day Air Early",
  "54": "International Express Plus",
  "59": "2 Day Air A.M",
  "64": "UPS Express NA1",
  "65": "UPS Saver",
  "70": "UPS Access Point Economy",
  "74": "UPS Express 12:00",
  "82": "UPS Today Standard",
  "83": "UPS Today Dedicated Courier",
  "84": "UPS Today Intercity",
  "85": "UPS Today Express",
  "86": "UPS Today Express Saver",
  "92": "SurePost Standard Parcel (not supported)",
  "93": "SurePost Parcel Select",
  "94": "SurePost Bound Printed Matter",
  "95": "SurePost Media Mail"
};

document.addEventListener("DOMContentLoaded", () => {
  socket = io();
  const currentUserEmail = "{{ current_user.email }}";
  const errorBox = document.getElementById("form-errors");
  const form = document.getElementById("form");

  document.querySelectorAll('td[data-ts]').forEach(td => {
    const raw = td.getAttribute('data-ts');
    if (!raw) return;

    const d = new Date(raw + "Z");
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    const timeStr = `${hours}:${minutes}`;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("month")) {
      const day = String(d.getDate()).padStart(2, '0'); 
      td.textContent = `${day}; ${timeStr}`;
    } else {
      td.textContent = timeStr;
    }
  });

  const validateFields = [
    { id: "Contact_Name", label: "Contact Name", max: 35, alphanumeric: true },
    { id: "Company_or_Name", label: "Company or Name", required: true, max: 35, alphanumeric: true },
    { id: "Country", label: "Country", required: true },
    { id: "Address_1", label: "Address 1", required: true, max: 35, alphanumeric: true },
    { id: "City", label: "City", required: true, max: 30, alphanumeric: true },
    { id: "Postal_Code", label: "Postal_Code", max: 10, alphanumeric: true },
    { id: "State_Prov_Other", label: "State/Province/Other", max: 30, alphanumeric: true },
    { id: "Telephone", label: "Telephone", max: 15, alphanumeric: true },
    { id: "Packaging_Type", label: "Packaging Type", required: true, max: 2 },
    { id: "Weight", label: "Weight", conditionalWeight: true ,  max: 5 },
    { id: "Length", label: "Length", numeric: true,  max: 4 },
    { id: "Width", label: "Width", numeric: true,  max: 4 },
    { id: "Height", label: "Height", numeric: true,  max: 4 },
    { id: "Description_of_Goods", label: "Description of Goods", max: 35, alphanumeric: true },
    { id: "Service", label: "Service", required: true, max: 2 },
    { id: "Reference_1", label: "Reference 1", max: 35, alphanumeric: true },
    { id: "Reference_2", label: "Reference 2", max: 35, alphanumeric: true }

  ];

  const alphanumericRegex = /^[\p{L}0-9\s]*$/u;

  function cleanInputValue(value, isPostalCode = false) {
    let cleaned = value;
    let wasModified = false;

    // Special handling for Postal Code
    if (isPostalCode) {
      const postalCleaned = cleaned.replace(/[^0-9]/g, '');
      if (postalCleaned !== cleaned) {
        wasModified = true;
        cleaned = postalCleaned;
      }
      return { cleaned, wasModified };
    }

    // Replace special chars between digits with space
    cleaned = cleaned.replace(/(\d)[^\p{L}\d\s]+(?=\d)/gu, (_, d) => {
      wasModified = true;
      return d + ' ';
    });

    // Remove special chars between words
    cleaned = cleaned.replace(/(\p{L})[^\p{L}\d\s]+(?=\p{L})/gu, (_, letter) => {
      wasModified = true;
      return letter;
    });

    // Remove all other special characters
    const finalCleaned = cleaned.replace(/[^\p{L}\d\s]/gu, '');
    if (finalCleaned !== cleaned) wasModified = true;

    return { cleaned: finalCleaned, wasModified };
  }

  const validCountryCodes = new Set([
    "AD", "AE", "AF", "AG", "AI", "AL", "AM", "AO", "AQ", "AR", "AS", "AT", "AU", "AW", "AX", "AZ",
    "BA", "BB", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BL", "BM", "BN", "BO", "BQ", "BR", "BS", "BT", "BV", "BW", "BY", "BZ",
    "CA", "CC", "CD", "CF", "CG", "CH", "CI", "CK", "CL", "CM", "CN", "CO", "CR", "CU", "CV", "CW", "CX", "CY", "CZ",
    "DE", "DJ", "DK", "DM", "DO", "DZ",
    "EC", "EE", "EG", "EH", "ER", "ES", "ET",
    "FI", "FJ", "FM", "FO", "FR",
    "GA", "GB", "GD", "GE", "GF", "GG", "GH", "GI", "GL", "GM", "GN", "GP", "GQ", "GR", "GT", "GU", "GW", "GY",
    "HK", "HM", "HN", "HR", "HT", "HU",
    "ID", "IE", "IL", "IM", "IN", "IO", "IQ", "IR", "IS", "IT",
    "JE", "JM", "JO", "JP",
    "KE", "KG", "KH", "KI", "KM", "KN", "KP", "KR", "KW", "KY", "KZ",
    "LA", "LB", "LC", "LI", "LK", "LR", "LS", "LT", "LU", "LV", "LY",
    "MA", "MC", "MD", "ME", "MF", "MG", "MH", "MK", "ML", "MM", "MN", "MO", "MP", "MQ", "MR", "MS", "MT", "MU", "MV", "MW", "MX", "MY", "MZ",
    "NA", "NC", "NE", "NF", "NG", "NI", "NL", "NO", "NP", "NR", "NU", "NZ",
    "OM",
    "PA", "PE", "PF", "PG", "PH", "PK", "PL", "PM", "PN", "PR", "PT", "PW", "PY",
    "QA",
    "RE", "RO", "RS", "RU", "RW",
    "SA", "SB", "SC", "SD", "SE", "SG", "SH", "SI", "SJ", "SK", "SL", "SM", "SN", "SO", "SR", "SS", "ST", "SV", "SX", "SY", "SZ",
    "TC", "TD", "TF", "TG", "TH", "TJ", "TK", "TL", "TM", "TN", "TO", "TR", "TT", "TV", "TZ",
    "UA", "UG", "UM", "US", "UY", "UZ",
    "VA", "VC", "VE", "VG", "VI", "VN", "VU",
    "WF", "WS",
    "YE", "YT",
    "ZA", "ZM", "ZW"
  ]);

  const fieldOrder = [
    "Contact Name","Company or Name","Country","Address 1","Address 2","Address 3","City","State/Prov/Other",
    "Postal Code","Telephone","Ext","Residential Ind","Consignee Email","Packaging Type","Customs Value",
    "Weight","Length","Width","Height","Unit of Measure","Description of Goods","Documents of No Commercial Value",
    "GNIFC","Pkg Decl Value","Service","Delivery Confirm","Shipper Release","Ret of Documents","Saturday Deliver",
    "Carbon Neutral","Large Package","Addl handling","Reference 1","Reference 2","Reference 3",
    "QV Notif 1-Addr","QV Notif 1-Ship","QV Notif 1-Excp","QV Notif 1-Delv",
    "QV Notif 2-Addr","QV Notif 2-Ship","QV Notif 2-Excp","QV Notif 2-Delv",
    "QV Notif 3-Addr","QV Notif 3-Ship","QV Notif 3-Excp","QV Notif 3-Delv",
    "QV Notif 4-Addr","QV Notif 4-Ship","QV Notif 4-Excp","QV Notif 4-Delv",
    "QV Notif 5-Addr","QV Notif 5-Ship","QV Notif 5-Excp","QV Notif 5-Delv",
    "QV Notif Msg","QV Failure Addr","UPS Premium Care","ADL Location ID","ADL Media Type",
    "ADL Language","ADL Notification Addr","ADL Failure Addr","ADL COD Value","ADL Deliver to Addressee",
    "ADL Shipper Media Type","ADL Shipper Language","ADL Shipper Notification Addr","ADL Direct Delivery Only",
    "Electronic Package Release Authentication","Lithium Ion Alone","Lithium Ion In Equipment",
    "Lithium Ion With_Equipment","Lithium Metal Alone","Lithium Metal In Equipment",
    "Lithium Metal With Equipment","Weekend Commercial Delivery","Dry Ice Weight","Merchandise Description",
    "UPS SurePost®Limited Quantity\\/Lithium Battery"
  ];


  const firstFieldId = fieldOrder[0].replace(/\s|\//g, "_");
  const firstInput = document.getElementById(firstFieldId);

  function clearForm() {
    form.reset(); // Clear standard fields

    // Clear custom fields safely
    const customIds = [
      "Custom_Order_Number",
      "Custom_Project_Number",
      "Custom_UPS_Number",
      "Custom_Cost",
      "Custom_Ship_Date"
    ];

    customIds.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = "";
    });

    // Clear error visuals
    document.querySelectorAll(".field-error").forEach(div => {
      div.innerText = "";
      div.classList.remove("field-warning");
    });
    document.querySelectorAll("input").forEach(input => input.classList.remove("input-error"));
  }

  form.onsubmit = e => {
    e.preventDefault();
    if (!validateAllFields()) return;

    let altered = false;

    validateFields.forEach(field => {
      const input = document.getElementById(field.id);
      if (!input) return;

      if (field.alphanumeric) {
        const { cleaned, wasModified } = cleanInputValue(input.value, field.id === "Postal_Code");
        if (wasModified) {
          input.value = cleaned;
          altered = true;
        }
      }
    });

    // Re-read all inputs AFTER cleaning
    const data = {};
    fieldOrder.forEach(field => {
      const id = field.replace(/\s|\//g, "_");
      const input = document.getElementById(id);
      if (input) data[field] = input.value.trim();
    });

    data["nr zamówienia gdzie będzie doliczony koszt"] = document.getElementById("Custom_Order_Number")?.value.trim() || "";
    data["NR PROJEKTU"] = document.getElementById("Custom_Project_Number")?.value.trim() || "";
    data["NR LISTU UPS"] = document.getElementById("Custom_UPS_Number")?.value.trim() || "";
    data["KOSZT (LOGISTYKA)"] = document.getElementById("Custom_Cost")?.value.trim() || "";
    data["DATA WYSYŁKI"] = document.getElementById("Custom_Ship_Date")?.value.trim() || "";

    if (altered) {
      SwalWithDarkTheme.fire({
        icon: 'info',
        title: 'Input Adjusted',
        text: 'Some fields contained special characters and were auto-corrected before submission.',
        confirmButtonText: 'Continue'
      }).then(() => {
        socket.emit("submit_form", data);

      });
    } else {
      socket.emit("submit_form", data);

    }

    if (document.getElementById("saveContactCheckbox").checked) {
      fetch("/save_contact", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(res => {
        if (res.status === 409) {
          SwalWithDarkTheme.fire({
            icon: "info",
            title: "Contact already exists",
            text: "This contact is already in the saved list.",
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          fetchSavedContacts();  // Refresh list
        }
      });
    }
  };
  
  firstInput?.addEventListener('paste', function (e) {
    e.preventDefault();
    const clipboard = e.clipboardData.getData('text/plain');
    const values = clipboard.split('\t').map(v => v.trim());

    // Removed alert for mismatched field count
    // if (values.length !== fieldOrder.length) {
    //   alert(`Pasted ${values.length} values but expected ${fieldOrder.length}. Some fields may be misaligned.`);
    // }

    let valueIndex = 0;
    for (let i = 0; i < fieldOrder.length && valueIndex < values.length; i++) {
      const id = fieldOrder[i].replace(/\s|\//g, "_");
      const input = document.getElementById(id);
      if (input) {
        const value = values[valueIndex];
        if (value !== undefined) {
          input.value = value.replace(/\s+/g, " ");
        } else {
          input.value = "";
        }
        valueIndex++;
      }
    }

    if (typeof validateAllFields === "function") validateAllFields();
  });

  socket.on("new_entry", data => {
    const tbody = document.getElementById("submission-body");
    if (!tbody) return;

    if ((data.data["_submitted_by"] || "") === currentUserEmail) {
      clearForm();
      SwalWithDarkTheme.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: 'Shipment added and form cleared.',
        showConfirmButton: false,
        timer: 2000
      });
    }

    const createdBy = data.data["_submitted_by"] || "?";
    const canDelete = createdBy === currentUserEmail;
    let timestamp = "?";
    if (data.data["_submitted_at"]) {
      const date = new Date(data.data["_submitted_at"] + "Z");
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      timestamp = `${hours}:${minutes}`;
    }

    const tr = document.createElement("tr");
    tr.setAttribute("data-id", data.id);
    tr.setAttribute("data-json", JSON.stringify(data.data)); // helpful for delete/undo

    const deleteTd = document.createElement("td");
    if (canDelete) {
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "✖";
      deleteBtn.className = "tiny-delete";

      deleteBtn.addEventListener("click", () => {
        SwalWithDarkTheme.fire({
          title: 'Are you sure?',
          text: 'This shipment will be deleted.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete it',
          cancelButtonText: 'Cancel',
        }).then((result) => {
          if (result.isConfirmed) {
            // store the data for potential undo
            recentlyDeleted = data.data;

            tr.classList.add("fading-out");
            setTimeout(() => {
              tr.remove();
              socket.emit("delete_entry", { id: data.id });

              SwalWithDarkTheme.fire({
                toast: true,
                position: 'bottom-end',
                icon: 'info',
                title: 'Deleted. Click to undo.',
                showConfirmButton: true,
                confirmButtonText: 'Undo',
                timer: 5000,
                timerProgressBar: true,
              }).then(result => {
                if (result.isConfirmed && recentlyDeleted) {
                  socket.emit("submit_form", recentlyDeleted);
                  recentlyDeleted = null;
                }
              });

            }, 300);
          }
        });
      });

      deleteTd.appendChild(deleteBtn);
    } else {
      deleteTd.innerHTML = "&mdash;";
    }
    tr.appendChild(deleteTd);

    const shownFields = [timestamp, createdBy,
      data.data["Contact Name"], data.data["Company or Name"], data.data["Country"], data.data["Address 1"],
      data.data["City"], data.data["State/Prov/Other"], data.data["Postal Code"], data.data["Telephone"],
      data.data["Consignee Email"], data.data["Packaging Type"], data.data["Weight"], data.data["Length"],
      data.data["Width"], data.data["Height"], data.data["Description of Goods"],
      data.data["Documents of No Commercial Value"], data.data["Service"],
      data.data["Reference 1"], data.data["Reference 2"],
      data.data["nr zamówienia gdzie będzie doliczony koszt"],
      data.data["NR PROJEKTU"], data.data["NR LISTU UPS"],
      data.data["KOSZT (LOGISTYKA)"], data.data["DATA WYSYŁKI"]
    ];

    shownFields.forEach(val => {
      const td = document.createElement("td");
      td.textContent = val || "";
      if (canDelete) td.classList.add("own-entry-cell");
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  socket.on("entry_deleted", data => {
    const row = document.querySelector(`tr[data-id="${data.id}"]`);
    if (row) {
      row.classList.add("fading-out");
      setTimeout(() => row.remove(), 300);
    }
  });

  socket.on('form_error', (payload) => {
  // Clear global box and any previous field errors
  document.getElementById("form-errors").style.display = "none";
  document.querySelectorAll("input").forEach(input => input.classList.remove("input-error"));
  document.querySelectorAll(".field-error").forEach(div => div.innerText = "");

  payload.errors.forEach(msg => {
    let matched = false;

    // Match to known fields and display inline error
    validateFields.forEach(field => {
      if (msg.includes(field.label)) {
        const input = document.getElementById(field.id);
        const errorDiv = document.getElementById("error-" + field.id);
        if (input && errorDiv) {
          input.classList.add("input-error");
          errorDiv.innerText = msg;
          matched = true;
        }
      }
    });

    // If not matched to a field, fall back to general error box
    if (!matched) {
      errorBox.innerText += msg + "\n";
      errorBox.style.display = "block";
    }
  });
});

function validateAllFields() {
  let hasError = false;

  document.querySelectorAll(".field-error").forEach(div => {
    div.innerText = "";
    div.classList.remove("field-warning");
  });

  // Clear all previous error messages and highlights
  document.querySelectorAll(".field-error").forEach(div => div.innerText = "");
  document.querySelectorAll("input").forEach(input => input.classList.remove("input-error"));

  validateFields.forEach(field => {
    const input = document.getElementById(field.id);
    const errorDiv = document.getElementById("error-" + field.id);
    if (!input || !errorDiv) return;

    const validateField = () => {
      const value = input.value.trim();
      input.classList.remove("input-error");
      errorDiv.innerText = "";
      errorDiv.classList.remove("field-warning");

      if (field.required && !value) {
        input.classList.add("input-error");
        errorDiv.innerText = `${field.label} is required.`;
        hasError = true;
        return;
      }

      if (field.max && value.length > field.max) {
        input.classList.add("input-error");
        errorDiv.innerText = `${field.label} must be ${field.max} characters or fewer.`;
        hasError = true;
        return;
      }

      if (field.alphanumeric) {
        const { cleaned, wasModified } = cleanInputValue(value, field.id === "Postal_Code");
        if (!/^[\p{L}0-9\s]*$/u.test(value)) {
          if (wasModified) {
            input.classList.remove("input-error");
            errorDiv.innerText = `${field.label} contains special characters and will be auto-corrected.`;
            errorDiv.classList.add("field-warning");
          } else {
            input.classList.add("input-error");
            errorDiv.innerText = `${field.label} must contain only letters, numbers, and spaces.`;
            hasError = true;
          }
          return;
        }
      }

      if (field.numeric && value && !/^\d+$/.test(value)) {
        input.classList.add("input-error");
        errorDiv.innerText = `${field.label} must contain only numbers.`;
        hasError = true;
        return;
      }

      if (field.conditionalWeight) {
        const packagingType = document.getElementById("Packaging_Type")?.value;
        if (packagingType === "2" && !value.trim()) {
          input.classList.add("input-error");
          errorDiv.innerText = `Weight is required for Packaging Type "2".`;
          hasError = true;
          return;
        }

        if (value && !/^\d+([.,]\d+)?$/.test(value)) {
          input.classList.add("input-error");
          errorDiv.innerText = `Weight must be a number (e.g., 10 or 10.5).`;
          hasError = true;
          return;
        }
      }

      if (field.id === "Country") {
        if (value.length !== 2) {
          input.classList.add("input-error");
          errorDiv.innerText = "Country code must be exactly 2 characters.";
          hasError = true;
        } else if (!validCountryCodes.has(value.toUpperCase())) {
          input.classList.add("input-error");
          errorDiv.innerText = "Invalid ISO country code (e.g., US, DE, JP).";
          hasError = true;
        }
      }
    };

    input.addEventListener('input', validateField);
    input.addEventListener('blur', validateField);

    validateField();
  });

  return !hasError;
}

async function fetchSavedContacts() {
  const res = await fetch("/get_contacts");
  const contacts = await res.json();
  const list = document.getElementById("contactList");
  list.innerHTML = "";
  contacts.forEach(contact => {
    const opt = document.createElement("option");
    opt.value = contact["Company or Name"] + " | " + contact["Contact Name"];
    opt.dataset.json = JSON.stringify(contact);
    list.appendChild(opt);
  });
}

document.getElementById("contactSearch").addEventListener("change", e => {
  const selected = Array.from(document.getElementById("contactList").options)
    .find(opt => opt.value === e.target.value);
  if (!selected) return;
  const data = JSON.parse(selected.dataset.json);
  Object.entries(data).forEach(([field, value]) => {
    const id = field.replace(/\s|\//g, "_");
    const input = document.getElementById(id);
    if (input) input.value = value;
  });
  document.getElementById("contactSearch").value = ""
});

fetchSavedContacts();


function setupAutocomplete(inputId, suggestionsId, map) {
  const input = document.getElementById(inputId);
  const suggestionsBox = document.getElementById(suggestionsId);
  const layer = document.getElementById("autocomplete-layer");
  if (!input || !suggestionsBox || !layer) return;

  function renderSuggestions(query) {
    suggestionsBox.innerHTML = "";
    const matches = Object.entries(map)
      .filter(([code, name]) =>
        code.includes(query) || name.toUpperCase().includes(query)
      )
      .slice(0, 25);

    if (matches.length === 0) {
      suggestionsBox.style.display = "none";
      return;
    }

    matches.forEach(([code, name]) => {
      const li = document.createElement("li");
      li.textContent = `${code} - ${name}`;
      li.addEventListener("click", () => {
        input.value = code;
        suggestionsBox.style.display = "none";
        if (typeof validateAllFields === "function") validateAllFields();
      });
      suggestionsBox.appendChild(li);
    });

    // Move suggestions box to the floating layer
    if (!layer.contains(suggestionsBox)) {
      layer.appendChild(suggestionsBox);
    }

    // Position suggestions box just below the input field
    const inputRect = input.getBoundingClientRect();
    suggestionsBox.style.position = "absolute";
    suggestionsBox.style.top = `${window.scrollY + inputRect.bottom}px`;
    suggestionsBox.style.left = `${window.scrollX + inputRect.left}px`;
    suggestionsBox.style.width = `${inputRect.width}px`;
    suggestionsBox.style.display = "block";
  }

  input.addEventListener("input", () => {
    const query = input.value.toUpperCase();
    renderSuggestions(query);
  });

  input.addEventListener("focus", () => {
    renderSuggestions("");
  });

  document.addEventListener("click", e => {
    if (!suggestionsBox.contains(e.target) && e.target !== input) {
      suggestionsBox.style.display = "none";
    }
  });
}
  // Setup all autocompletes here
  setupAutocomplete("Country", "country-suggestions", countryMap);
  setupAutocomplete("Packaging_Type", "packaging-suggestions", packagingMap);
  setupAutocomplete("Service", "service-suggestions", serviceMap);

  // Toggle Advanced Fields (with scroll + remember state)
  const wrapper = document.getElementById("advanced-wrapper");
  const toggleBtn = document.getElementById("toggle-advanced");

  if (toggleBtn && wrapper) {
      toggleBtn.addEventListener("click", () => {
        const isVisible = wrapper.classList.toggle("show");
        toggleBtn.textContent = isVisible ? "Hide Advanced Fields" : "Show Advanced Fields";
        localStorage.setItem("advancedVisible", isVisible);
        if (isVisible) wrapper.scrollIntoView({ behavior: "smooth", block: "start" });
      });

    if (localStorage.getItem("advancedVisible") === "true") {
      wrapper.classList.add("show");
      toggleBtn.textContent = "Hide Advanced Fields";
    }
  }   

  document.querySelectorAll('.tooltip-icon').forEach(icon => {
    let tooltip;

    icon.addEventListener('mouseenter', e => {
      const contentEl = icon.querySelector('.tooltip-content');
      if (!contentEl) return;

      tooltip = document.createElement('div');
      tooltip.className = 'floating-tooltip';
      tooltip.textContent = contentEl.textContent;
      tooltip.style.opacity = "0";
      document.body.appendChild(tooltip);

      // Position initially
      tooltip.style.position = 'absolute';
      tooltip.style.pointerEvents = 'none';

      const moveTooltip = (evt) => {
        const xOffset = 15;
        const yOffset = 20;
        tooltip.style.top = `${evt.clientY + yOffset + window.scrollY}px`;
        tooltip.style.left = `${evt.clientX + xOffset + window.scrollX}px`;
      };

      document.addEventListener('mousemove', moveTooltip);
      tooltip._moveHandler = moveTooltip;

      requestAnimationFrame(() => {
        tooltip.style.opacity = "1";
      });
    });

    icon.addEventListener('mouseleave', () => {
      if (tooltip) {
        document.removeEventListener('mousemove', tooltip._moveHandler);
        tooltip.remove();
        tooltip = null;
      }
    });
  });

});

let recentlyDeleted = null;

function deleteEntry(id) {
  const row = document.querySelector(`tr[data-id="${id}"]`);
  if (!row) return;

  SwalWithDarkTheme.fire({
    title: 'Are you sure?',
    text: 'This shipment will be deleted.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete it',
    cancelButtonText: 'Cancel',
  }).then((result) => {
    if (result.isConfirmed) {
      // Save full data from row attribute
      const json = row.getAttribute("data-json");
      if (!json) return;

      try {
        recentlyDeleted = JSON.parse(json);
      } catch (e) {
        console.error("Failed to parse row data for undo", e);
        return;
      }

      row.classList.add("fading-out");
      setTimeout(() => {
        row.remove();
        socket.emit("delete_entry", { id });

        SwalWithDarkTheme.fire({
          toast: true,
          position: 'bottom-end',
          icon: 'info',
          title: 'Deleted. Click to undo.',
          showConfirmButton: true,
          confirmButtonText: 'Undo',
          timer: 5000,
          timerProgressBar: true,
        }).then(result => {
          if (result.isConfirmed && recentlyDeleted) {
            socket.emit("submit_form", recentlyDeleted);
            recentlyDeleted = null;
          }
        });

      }, 300);
    }
  });
}

function rebuildDataFromCells(cells) {
  const fieldMap = [
    "Time", "_submitted_by", "Contact Name", "Company or Name", "Country", "Address 1", "City", "State/Prov/Other",
    "Postal Code", "Telephone", "Consignee Email", "Packaging Type", "Weight", "Length", "Width", "Height",
    "Description of Goods", "Documents of No Commercial Value", "Service", "Reference 1", "Reference 2",
    "nr zamówienia gdzie będzie doliczony koszt", "NR PROJEKTU", "NR LISTU UPS", "KOSZT (LOGISTYKA)", "DATA WYSYŁKI"
  ];

  const data = {};
  fieldMap.forEach((key, i) => {
    if (i < cells.length) {
      const raw = cells[i];
      const clean = raw.replace(/<[^>]+>/g, '').trim(); // strip HTML
      if (key === "Time" || key === "_submitted_by") return; // skip non-form fields
      data[key] = clean;
    }
  });

  return data;
}

document.addEventListener("DOMContentLoaded", function () {
  let pickerInstance;
  const pickerInput = document.getElementById("unified-picker");
  const viewMode = document.getElementById("view-mode");

  // Detect current mode from URL
  const urlParams = new URLSearchParams(window.location.search);
  let initialMode = "date";
  if (urlParams.has("month")) {
    initialMode = "month";
  }

  // Set dropdown value to match URL
  viewMode.value = initialMode;

  function initFlatpickr(mode) {
    if (pickerInstance) {
      pickerInstance.destroy();
    }

    if (mode === "month") {
      pickerInstance = flatpickr(pickerInput, {
        dateFormat: "Y-m",
        defaultDate: "{{ selected_month or selected_date }}",
        plugins: [new monthSelectPlugin({
          shorthand: true,
          dateFormat: "Y-m",
          altFormat: "F Y"
        })],
        onChange: function(selectedDates, dateStr) {
          window.location.href = `/?month=${dateStr}`;
        }
      });
    } else {
      pickerInstance = flatpickr(pickerInput, {
        dateFormat: "Y-m-d",
        defaultDate: "{{ selected_date or '' }}",
        onChange: function(selectedDates, dateStr) {
          window.location.href = `/?date=${dateStr}`;
        }
      });
    }
  }

  // 🔹 Initialize the picker based on detected mode
  initFlatpickr(initialMode);

  // 🔹 Update picker mode on dropdown change
  viewMode.addEventListener("change", function () {
    initFlatpickr(this.value);
  });
});

</script>
<div id="autocomplete-layer"></div>
<ul id="country-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="packaging-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="service-suggestions" class="autocomplete-list" style="display: none;"></ul>
</body>
</html>
