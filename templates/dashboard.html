<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UPS Dashboard</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #f0f0f0;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #1e1e1e;
            color: #f0f0f0;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
        }
        th {
            background-color: #333;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #f0f0f0;
        }
        button {
            background-color: #4caf50;
            cursor: pointer;
        }
        .delete-button {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <h2>Shared UPS Data Workspace</h2>
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="window.location='/logout'">Logout</button>
    <table>
        <thead>
            <tr>
                <th>Contact Name</th><th>Company</th><th>Country</th><th>City</th><th>Postal Code</th><th>Action</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <div>
        <input placeholder="Contact Name" id="name">
        <input placeholder="Company" id="company">
        <input placeholder="Country" id="country">
        <input placeholder="City" id="city">
        <input placeholder="Postal Code" id="postal">
        <button onclick="addRow()">Add</button>
    </div>
<script>
const socket = io();
const tableBody = document.getElementById('tableBody');

function addRow() {
    const data = {
        "Contact Name": document.getElementById('name').value,
        "Company": document.getElementById('company').value,
        "Country": document.getElementById('country').value,
        "City": document.getElementById('city').value,
        "Postal Code": document.getElementById('postal').value
    };
    socket.emit('add_entry', data);
}

function renderRow(entry) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-id', entry.id);
    for (const key of ["Contact Name", "Company", "Country", "City", "Postal Code"]) {
        const td = document.createElement('td');
        td.contentEditable = true;
        td.innerText = entry.data[key] || "";
        td.onblur = () => {
            entry.data[key] = td.innerText;
            socket.emit('update_entry', entry);
        };
        tr.appendChild(td);
    }
    const tdDel = document.createElement('td');
    tdDel.innerHTML = '<button class="delete-button" onclick="deleteRow(' + entry.id + ')">Delete</button>';
    tr.appendChild(tdDel);
    tableBody.appendChild(tr);
}

function deleteRow(id) {
    socket.emit('delete_entry', {id});
}

socket.on('new_entry', renderRow);
socket.on('entry_updated', data => {
    const row = document.querySelector(`tr[data-id='${data.id}']`);
    if (row) row.remove();
    renderRow(data);
});
socket.on('entry_deleted', data => {
    const row = document.querySelector(`tr[data-id='${data.id}']`);
    if (row) row.remove();
});

function downloadCSV() {
    window.location.href = "/download";
}

// Initial rows from server
{% for entry in entries %}
    renderRow({id: {{ entry.id }}, data: {{ entry.data|tojson }} });
{% endfor %}
</script>
</body>
</html>
