<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"><title>UPS Full Form</title><script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script></head>
<body>
  <header>
    <div>Welcome, {{ current_user.email }}</div>
    <a href="/logout">Logout</a>
  </header>

<div class="container">
<h2>UPS Form</h2>

<form id="form">
  <div class="vertical-form">
    <div class="vertical-field">
      <label for="Contact_Name">Contact Name</label>
      <input type="text" id="Contact_Name">
    </div>
    <div class="vertical-field">
      <label for="Company_or_Name">Company or Name</label>
      <input type="text" id="Company_or_Name">
    </div>
    <div class="vertical-field">
      <label for="Country">Country</label>
      <div class="input-wrapper">
        <input type="text" id="Country">
        <ul id="country-suggestions" class="autocomplete-list" style="display: none;"></ul>
      </div>
    </div>
    <div class="vertical-field">
      <label for="Address_1">Address 1</label>
      <input type="text" id="Address_1">
    </div>
    <div class="vertical-field">
      <label for="Address_2">Address 2</label>
      <input type="text" id="Address_2">
    </div>
    <div class="vertical-field">
      <label for="Address_3">Address 3</label>
      <input type="text" id="Address_3">
    </div>
    <div class="vertical-field">
      <label for="City">City</label>
      <input type="text" id="City">
    </div>
    <div class="vertical-field">
      <label for="State_Prov_Other">State/Prov/Other</label>
      <input type="text" id="State_Prov_Other">
    </div>
    <div class="vertical-field">
      <label for="Postal_Code">Postal Code</label>
      <input type="text" id="Postal_Code">
    </div>
    <div class="vertical-field">
      <label for="Telephone">Telephone</label>
      <input type="text" id="Telephone">
    </div>
    <div class="vertical-field">
      <label for="Ext">Ext</label>
      <input type="text" id="Ext">
    </div>
    <div class="vertical-field">
      <label for="Residential_Ind">Residential Ind</label>
      <div class="input-wrapper">
        <input type="text" id="Residential_Ind">
        <ul id="residential-suggestions" class="autocomplete-list" style="display: none;"></ul>
      </div>
    </div>
    <div class="vertical-field">
      <label for="Consignee_Email">Consignee Email</label>
      <input type="text" id="Consignee_Email">
    </div>
    <div class="vertical-field">
      <label for="Packaging_Type">Packaging Type</label>
      <div class="input-wrapper">
        <input type="text" id="Packaging_Type">
        <ul id="packaging-suggestions" class="autocomplete-list" style="display: none;"></ul>
      </div>
    </div>
    <div class="vertical-field">
      <label for="Customs_Value">Customs Value</label>
      <input type="text" id="Customs_Value">
    </div>
    <div class="vertical-field">
      <label for="Weight">Weight</label>
      <input type="text" id="Weight">
    </div>
    <div class="vertical-field">
      <label for="Length">Length</label>
      <input type="text" id="Length">
    </div>
    <div class="vertical-field">
      <label for="Width">Width</label>
      <input type="text" id="Width">
    </div>
    <div class="vertical-field">
      <label for="Height">Height</label>
      <input type="text" id="Height">
    </div>
    <div class="vertical-field">
      <label for="Unit_of_Measure">Unit of Measure</label>
      <select id="Unit_of_Measure">
        <option value="">--</option>
        <option value="KG">KG</option>
        <option value="LB">LB</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Description_of_Goods">Description of Goods</label>
      <input type="text" id="Description_of_Goods">
    </div>
    <div class="vertical-field">
      <label for="Documents_of_No_Commercial_Value">Documents of No Commercial Value</label>
      <select id="Documents_of_No_Commercial_Value">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="GNIFC">GNIFC</label>
      <select id="GNIFC">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Pkg_Decl_Value">Pkg Decl Value</label>
      <input type="text" id="Pkg_Decl_Value">
    </div>
    <div class="vertical-field">
      <label for="Service">Service</label>
      <div class="input-wrapper">
        <input type="text" id="Service">
        <ul id="service-suggestions" class="autocomplete-list" style="display: none;"></ul>
      </div>
    </div>
    <div class="vertical-field">
      <label for="Delivery_Confirm">Delivery Confirm</label>
      <div class="input-wrapper">
        <input type="text" id="Delivery_Confirm">
        <ul id="deliveryconfirm-suggestions" class="autocomplete-list" style="display: none;"></ul>
      </div>
    </div>
    <div class="vertical-field">
      <label for="Shipper_Release">Shipper Release</label>
      <select id="Shipper_Release">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Ret_of_Documents">Ret of Documents</label>
      <select id="Ret_of_Documents">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Saturday_Deliver">Saturday Deliver</label>
      <select id="Saturday_Deliver">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Carbon_Neutral">Carbon Neutral</label>
      <select id="Carbon_Neutral">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Large_Package">Large Package</label>
      <select id="Large_Package">
        <option value="">--</option>
        <option value="1">1</option>
      </select>
    </div>
    <div class="vertical-field">
      <label for="Addl_handling">Addl handling</label>
      <input type="text" id="Addl_handling">
    </div>
    <div class="vertical-field">
      <label for="Reference_1">Reference 1</label>
      <input type="text" id="Reference_1">
    </div>
    <div class="vertical-field">
      <label for="Reference_2">Reference 2</label>
      <input type="text" id="Reference_2">
    </div>
    <div class="vertical-field">
      <label for="Reference_3">Reference 3</label>
      <input type="text" id="Reference_3">
    </div>
  </div>

  <div class="form-submit">
    <button type="button" id="toggle-advanced" class="submit-button">
      Show Advanced Fields
    </button>
  </div>

  <div id="advanced-wrapper" class="vertical-form">
  <div class="vertical-field">
    <label for="QV_Notif_1-Addr">QV Notif 1-Addr</label>
    <input type="text" id="QV_Notif_1-Addr">
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_1-Ship">QV Notif 1-Ship</label>
    <select id="QV_Notif_1-Ship">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_1-Excp">QV Notif 1-Excp</label>
    <select id="QV_Notif_1-Excp">
      <option value="">--</option>
      <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_1-Delv">QV Notif 1-Delv</label>
    <select id="QV_Notif_1-Delv">
      <option value="">--</option>
      <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_2-Addr">QV Notif 2-Addr</label>
    <input type="text" id="QV_Notif_2-Addr">
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_2-Ship">QV Notif 2-Ship</label>
    <select id="QV_Notif_2-Ship">
      <option value="">--</option>
      <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_2-Excp">QV Notif 2-Excp</label>
    <select id="QV_Notif_2-Excp">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_2-Delv">QV Notif 2-Delv</label>
    <select id="QV_Notif_2-Delv">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_3-Addr">QV Notif 3-Addr</label>
    <input type="text" id="QV_Notif_3-Addr">
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_3-Ship">QV Notif 3-Ship</label>
    <select id="QV_Notif_3-Ship">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_3-Excp">QV Notif 3-Excp</label>
    <select id="QV_Notif_3-Excp">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_3-Delv">QV Notif 3-Delv</label>
    <select id="QV_Notif_3-Delv">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_4-Addr">QV Notif 4-Addr</label>
    <input type="text" id="QV_Notif_4-Addr">
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_4-Ship">QV Notif 4-Ship</label>
    <select id="QV_Notif_4-Ship">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_4-Excp">QV Notif 4-Excp</label>
    <select id="QV_Notif_4-Excp">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_4-Delv">QV Notif 4-Delv</label>
    <select id="QV_Notif_4-Delv">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_5-Addr">QV Notif 5-Addr</label>
    <input type="text" id="QV_Notif_5-Addr">
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_5-Ship">QV Notif 5-Ship</label>
    <select id="QV_Notif_5-Ship">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_5-Excp">QV Notif 5-Excp</label>
    <select id="QV_Notif_5-Excp">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_5-Delv">QV Notif 5-Delv</label>
    <select id="QV_Notif_5-Delv">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="QV_Notif_Msg">QV Notif Msg</label>
    <input type="text" id="QV_Notif_Msg">
  </div>
  <div class="vertical-field">
    <label for="QV_Failure_Addr">QV Failure Addr</label>
    <input type="text" id="QV_Failure_Addr">
  </div>
  <div class="vertical-field">
    <label for="UPS_Premium_Care">UPS Premium Care</label>
    <select id="UPS_Premium_Care">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="ADL_Location_ID">ADL Location ID</label>
    <input type="text" id="ADL_Location_ID">
  </div>
  <div class="vertical-field">
    <label for="ADL_Media_Type">ADL Media Type</label>
    <div class="input-wrapper">
      <input type="text" id="ADL_Media_Type">
      <ul id="adlmediatype-suggestions" class="autocomplete-list" style="display: none;"></ul>
    </div>
  </div>
  <div class="vertical-field">
    <label for="ADL_Language">ADL Language</label>
    <input type="text" id="ADL_Language">
  </div>
  <div class="vertical-field">
    <label for="ADL_Notification_Addr">ADL Notification Addr</label>
    <input type="text" id="ADL_Notification_Addr">
  </div>
  <div class="vertical-field">
    <label for="ADL_Failure_Addr">ADL Failure Addr</label>
    <input type="text" id="ADL_Failure_Addr">
  </div>
  <div class="vertical-field">
    <label for="ADL_COD_Value">ADL COD Value</label>
    <input type="text" id="ADL_COD_Value">
  </div>
  <div class="vertical-field">
    <label for="ADL_Deliver_to_Addressee">ADL Deliver to Addressee</label>
    <div class="input-wrapper">
      <input type="text" id="ADL_Deliver_to_Addressee">
      <ul id="adldeliveraddr-suggestions" class="autocomplete-list" style="display: none;"></ul>
    </div>
  </div>
  <div class="vertical-field">
    <label for="ADL_Shipper_Media_Type">ADL Shipper Media Type</label>
    <div class="input-wrapper">
      <input type="text" id="ADL_Shipper_Media_Type">
      <ul id="adlshippermediatype-suggestions" class="autocomplete-list" style="display: none;"></ul>
    </div>
  </div>
  <div class="vertical-field">
    <label for="ADL_Shipper_Language">ADL Shipper Language</label>
    <input type="text" id="ADL_Shipper_Language">
  </div>
  <div class="vertical-field">
    <label for="ADL_Shipper_Notification_Addr">ADL Shipper Notification Addr</label>
    <input type="text" id="ADL_Shipper_Notification_Addr">
  </div>
  <div class="vertical-field">
    <label for="ADL_Direct_Delivery_Only">ADL Direct Delivery Only</label>
    <select id="ADL_Direct_Delivery_Only">
        <option value="">--</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Electronic_Package_Release_Authentication">Electronic Package Release Authentication</label>
    <input type="text" id="Electronic_Package_Release_Authentication">
  </div>
  <div class="vertical-field">
    <label for="Lithium_Ion_Alone">Lithium Ion Alone</label>
    <select id="Lithium_Ion_Alone">
        <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Lithium_Ion_In_Equipment">Lithium Ion In Equipment</label>
    <select id="Lithium_Ion_In_Equipment">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Lithium_Ion_With_Equipment">Lithium Ion With_Equipment</label>
    <select id="Lithium_Ion_With_Equipment">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Lithium_Metal_Alone">Lithium Metal Alone</label>
    <select id="Lithium_Metal_Alone">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Lithium_Metal_In_Equipment">Lithium Metal In Equipment</label>
    <select id="Lithium_Metal_In_Equipment">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Lithium_Metal_With_Equipment">Lithium Metal With Equipment</label>
    <select id="Lithium_Metal_With_Equipment">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Weekend_Commercial_Delivery">Weekend Commercial Delivery</label>
    <select id="Weekend_Commercial_Delivery">
      <option value="">--</option>
      <option value="1">1</option>
    </select>
  </div>
  <div class="vertical-field">
    <label for="Dry_Ice_Weight">Dry Ice Weight</label>
    <input type="text" id="Dry_Ice_Weight">
  </div>
  <div class="vertical-field">
    <label for="Merchandise_Description">Merchandise Description</label>
    <input type="text" id="Merchandise_Description">
  </div>
  <div class="vertical-field">
    <label for="UPS_SurePost®Limited_Quantity_Lithium_Battery">UPS SurePost®Limited Quantity/Lithium Battery</label>
    <select id="UPS_SurePost®Limited_Quantity_Lithium_Battery">
      <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
      </select>
  </div>
</div>

  <div class="form-submit">
    <button type="submit" class="submit-button">Add</button>
  </div>

</form>

<div class="form-errors-wrapper">
  <div id="form-errors" class="error-box" style="display: none;"></div>
</div>

  <h3>Live Table</h3>
  <table id="table">
    <thead>
      <tr>
        <th>Time</th><th>User</th><th>Contact</th><th>Company</th><th>Country</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

    <a href="/download" class="button-link">Download CSV</a>
</div>

<script>
const socket = io();
document.getElementById("form").onsubmit = e => {
    e.preventDefault();
    let data = {};
    ["Contact Name","Company or Name","Country","Address 1","Address 2","Address 3","City","State/Prov/Other","Postal Code","Telephone","Ext","Residential Ind","Consignee Email","Packaging Type","Customs Value","Weight","Length","Width","Height","Unit of Measure","Description of Goods","Documents of No Commercial Value","GNIFC","Pkg Decl Value","Service","Delivery Confirm","Shipper Release","Ret of Documents","Saturday Deliver","Carbon Neutral","Large Package","Addl handling","Reference 1","Reference 2","Reference 3","QV Notif 1-Addr","QV Notif 1-Ship","QV Notif 1-Excp","QV Notif 1-Delv","QV Notif 2-Addr","QV Notif 2-Ship","QV Notif 2-Excp","QV Notif 2-Delv","QV Notif 3-Addr","QV Notif 3-Ship","QV Notif 3-Excp","QV Notif 3-Delv","QV Notif 4-Addr","QV Notif 4-Ship","QV Notif 4-Excp","QV Notif 4-Delv","QV Notif 5-Addr","QV Notif 5-Ship","QV Notif 5-Excp","QV Notif 5-Delv","QV Notif Msg","QV Failure Addr","UPS Premium Care","ADL Location ID","ADL Media Type","ADL Language","ADL Notification Addr","ADL Failure Addr","ADL COD Value","ADL Deliver to Addressee","ADL Shipper Media Type","ADL Shipper Language","ADL Shipper Notification Addr","ADL Direct Delivery Only","Electronic Package Release Authentication","Lithium Ion Alone","Lithium Ion In Equipment","Lithium Ion With_Equipment","Lithium Metal Alone","Lithium Metal In Equipment","Lithium Metal With Equipment","Weekend Commercial Delivery","Dry Ice Weight","Merchandise Description","UPS SurePost®Limited Quantity/Lithium Battery"].forEach(field => {
        let id = field.replace(/\s|\//g, "_");
        data[field] = document.getElementById(id).value;
    });
    socket.emit("submit_form", data);
};

socket.on('form_error', (payload) => {
  const errorBox = document.getElementById("form-errors");

  // Clear previous highlights
  document.querySelectorAll("input").forEach(input => input.classList.remove("input-error"));

  // Highlight fields mentioned in error text (if possible)
  const fieldsToHighlight = [];

  payload.errors.forEach(error => {
    if (error.includes("Company or Name")) fieldsToHighlight.push("Company_or_Name");
    if (error.includes("Address 1")) fieldsToHighlight.push("Address_1");
    if (error.includes("City")) fieldsToHighlight.push("City");
    if (error.includes("Packaging Type")) fieldsToHighlight.push("Packaging_Type");
    if (error.includes("Service")) fieldsToHighlight.push("Service");
  });

  fieldsToHighlight.forEach(id => {
    const input = document.getElementById(id);
    if (input) input.classList.add("input-error");
  });

  errorBox.innerText = "Please fix the following issues:\n" + payload.errors.join("\n");
  errorBox.style.display = "block";
});

socket.on("new_entry", data => {
    document.getElementById("form-errors").style.display = "none";
    document.querySelectorAll("input").forEach(input => input.classList.remove("input-error"));
    const row = document.createElement("tr");
    row.setAttribute("data-id", data.id);
    row.innerHTML = `
  <td>${data.data["_submitted_at"]?.slice(0, 19).replace("T", " ") || "?"}</td>
  <td>${data.data["_submitted_by"] || "?"}</td>
  <td>${data.data["Contact Name"]}</td>
  <td>${data.data["Company or Name"]}</td>
  <td>${data.data["Country"]}</td>
  <td><button onclick="deleteEntry(${data.id})">Delete</button></td>
`;
    document.querySelector("#table tbody").appendChild(row);
});

const errorBox = document.getElementById("form-errors");

const validateFields = [
  { id: "Contact_Name", label: "Contact Name", max: 35 },
  { id: "Company_or_Name", label: "Company or Name", max: 35 },
  { id: "Country", label: "Country", max: 2 },
  { id: "Address_1", label: "Address 1", max: 35 },
  { id: "Address_2", label: "Address 2", max: 35 },
  { id: "Address_3", label: "Address 3", max: 35 },
  { id: "Description_of_Goods", label: "Description of Goods", max: 35 },
  { id: "Reference_1", label: "Reference 1", max: 35 },
  { id: "Reference_2", label: "Reference 2", max: 35 },
  { id: "Reference_3", label: "Reference 3", max: 35 },
  { id: "Merchandise_Description", label: "Merchandise Description", max: 35 },
  { id: "City", label: "City", max: 30 },
  { id: "State_Prov_Other", label: "State/Province/Other", max: 30 }
];

const alphanumericRegex = /^[a-zA-Z0-9\\s]*$/;
const validCountryCodes = new Set([
  "AD", "AE", "AF", "AG", "AI", "AL", "AM", "AO", "AQ", "AR", "AS", "AT", "AU", "AW", "AX", "AZ",
  "BA", "BB", "BD", "BE", "BF", "BG", "BH", "BI", "BJ", "BL", "BM", "BN", "BO", "BQ", "BR", "BS", "BT", "BV", "BW", "BY", "BZ",
  "CA", "CC", "CD", "CF", "CG", "CH", "CI", "CK", "CL", "CM", "CN", "CO", "CR", "CU", "CV", "CW", "CX", "CY", "CZ",
  "DE", "DJ", "DK", "DM", "DO", "DZ",
  "EC", "EE", "EG", "EH", "ER", "ES", "ET",
  "FI", "FJ", "FM", "FO", "FR",
  "GA", "GB", "GD", "GE", "GF", "GG", "GH", "GI", "GL", "GM", "GN", "GP", "GQ", "GR", "GT", "GU", "GW", "GY",
  "HK", "HM", "HN", "HR", "HT", "HU",
  "ID", "IE", "IL", "IM", "IN", "IO", "IQ", "IR", "IS", "IT",
  "JE", "JM", "JO", "JP",
  "KE", "KG", "KH", "KI", "KM", "KN", "KP", "KR", "KW", "KY", "KZ",
  "LA", "LB", "LC", "LI", "LK", "LR", "LS", "LT", "LU", "LV", "LY",
  "MA", "MC", "MD", "ME", "MF", "MG", "MH", "MK", "ML", "MM", "MN", "MO", "MP", "MQ", "MR", "MS", "MT", "MU", "MV", "MW", "MX", "MY", "MZ",
  "NA", "NC", "NE", "NF", "NG", "NI", "NL", "NO", "NP", "NR", "NU", "NZ",
  "OM",
  "PA", "PE", "PF", "PG", "PH", "PK", "PL", "PM", "PN", "PR", "PT", "PW", "PY",
  "QA",
  "RE", "RO", "RS", "RU", "RW",
  "SA", "SB", "SC", "SD", "SE", "SG", "SH", "SI", "SJ", "SK", "SL", "SM", "SN", "SO", "SR", "SS", "ST", "SV", "SX", "SY", "SZ",
  "TC", "TD", "TF", "TG", "TH", "TJ", "TK", "TL", "TM", "TN", "TO", "TR", "TT", "TV", "TZ",
  "UA", "UG", "UM", "US", "UY", "UZ",
  "VA", "VC", "VE", "VG", "VI", "VN", "VU",
  "WF", "WS",
  "YE", "YT",
  "ZA", "ZM", "ZW"
]);

function validateAllFields() {
  let firstError = null;
  errorBox.innerText = ""; // Clear old errors
  let hasError = false;

  validateFields.forEach(field => {
    const input = document.getElementById(field.id);
    if (!input) return;

    input.classList.remove("input-error");
    const value = input.value;

    if (value.length > field.max) {
      hasError = true;
      input.classList.add("input-error");
      if (!firstError) firstError = `${field.label} must be ${field.max} characters or fewer.`;
    } else if (!alphanumericRegex.test(value)) {
      hasError = true;
      input.classList.add("input-error");
      if (!firstError) firstError = `${field.label} must contain only letters, numbers, and spaces.`;
    }
    // Special rule for Country (must be valid ISO Alpha-2 code)
    if (field.id === "Country") {
      if (value.length !== 2) {
        hasError = true;
        input.classList.add("input-error");
        if (!firstError) firstError = "Country code must be exactly 2 characters.";
      } else if (!validCountryCodes.has(value.toUpperCase())) {
        hasError = true;
        input.classList.add("input-error");
        if (!firstError) firstError = "Invalid ISO country code (e.g., US, DE, JP).";
      }
    }
  });

  if (hasError) {
    errorBox.innerText = firstError;
    errorBox.style.display = "block";
  } else {
    errorBox.innerText = "";
    errorBox.style.display = "none";
  }
}

validateFields.forEach(field => {
  const input = document.getElementById(field.id);
  if (!input) return;
  input.addEventListener("input", validateAllFields);
});


function deleteEntry(id) {
    socket.emit("delete_entry", {id});
}

socket.on("entry_deleted", data => {
    const row = document.querySelector(`tr[data-id='${data.id}']`);
    if (row) row.remove();
});

const fieldOrder = [ "Contact Name", "Company or Name", "Country", "Address 1", "Address 2", "Address 3", "City", "State/Prov/Other",
    "Postal Code", "Telephone", "Ext", "Residential Ind", "Consignee Email", "Packaging Type", "Customs Value",
    "Weight", "Length", "Width", "Height", "Unit of Measure", "Description of Goods", "Documents of No Commercial Value",
    "GNIFC", "Pkg Decl Value", "Service", "Delivery Confirm", "Shipper Release", "Ret of Documents", "Saturday Deliver",
    "Carbon Neutral", "Large Package", "Addl handling", "Reference 1", "Reference 2", "Reference 3", "QV Notif 1-Addr",
    "QV Notif 1-Ship", "QV Notif 1-Excp", "QV Notif 1-Delv", "QV Notif 2-Addr", "QV Notif 2-Ship", "QV Notif 2-Excp",
    "QV Notif 2-Delv", "QV Notif 3-Addr", "QV Notif 3-Ship", "QV Notif 3-Excp", "QV Notif 3-Delv", "QV Notif 4-Addr",
    "QV Notif 4-Ship", "QV Notif 4-Excp", "QV Notif 4-Delv", "QV Notif 5-Addr", "QV Notif 5-Ship", "QV Notif 5-Excp",
    "QV Notif 5-Delv", "QV Notif Msg", "QV Failure Addr", "UPS Premium Care", "ADL Location ID", "ADL Media Type",
    "ADL Language", "ADL Notification Addr", "ADL Failure Addr", "ADL COD Value", "ADL Deliver to Addressee",
    "ADL Shipper Media Type", "ADL Shipper Language", "ADL Shipper Notification Addr", "ADL Direct Delivery Only",
    "Electronic Package Release Authentication", "Lithium Ion Alone", "Lithium Ion In Equipment",
    "Lithium Ion With_Equipment", "Lithium Metal Alone", "Lithium Metal In Equipment",
    "Lithium Metal With Equipment", "Weekend Commercial Delivery", "Dry Ice Weight", "Merchandise Description",
    "UPS SurePost®Limited Quantity/Lithium Battery" ];

const firstFieldId = fieldOrder[0].replace(/\s|\//g, "_");
const firstInput = document.getElementById(firstFieldId);

firstInput.addEventListener('paste', function (e) {
  e.preventDefault();
  const clipboard = e.clipboardData.getData('text/plain');
  const values = clipboard.split('\t');

  fieldOrder.forEach((field, i) => {
    const id = field.replace(/\s|\//g, "_");
    const input = document.getElementById(id);
    if (input && values[i] !== undefined) {
      input.value = values[i];
    }
  });
});

document.getElementById("form").onsubmit = function(e) {
  e.preventDefault();
  const data = {};

  fieldOrder.forEach(field => {
    const id = field.replace(/\s|\//g, "_");
    const input = document.getElementById(id);
    if (input) data[field] = input.value;
  });

  socket.emit("submit_form", data);
};

function renderRow(entry) {
  const row = document.createElement("tr");
  row.setAttribute("data-id", entry.id);s
  row.innerHTML = `
    <td>${entry.data["_submitted_at"]?.slice(0, 19).replace("T", " ") || "?"}</td>
    <td>${entry.data["_submitted_by"] || "?"}</td>
    <td>${entry.data["Contact Name"]}</td>
    <td>${entry.data["Company or Name"]}</td>
    <td>${entry.data["Country"]}</td>
    <td><button onclick="deleteEntry(${entry.id})">Delete</button></td>
  `;
  document.querySelector("#table tbody").appendChild(row);
}

{% for entry in entries %}
  renderRow({ id: {{ entry.id }}, data: {{ entry.data|tojson }} });
{% endfor %}

document.addEventListener("DOMContentLoaded", () => {
const countryMap = {
 "AD": "Andorra",
  "AE": "United Arab Emirates",
  "AF": "Afghanistan",
  "AG": "Antigua and Barbuda",
  "AI": "Anguilla",
  "AL": "Albania",
  "AM": "Armenia",
  "AO": "Angola",
  "AQ": "Antarctica",
  "AR": "Argentina",
  "AS": "American Samoa",
  "AT": "Austria",
  "AU": "Australia",
  "AW": "Aruba",
  "AX": "Åland Islands",
  "AZ": "Azerbaijan",
  "BA": "Bosnia and Herzegovina",
  "BB": "Barbados",
  "BD": "Bangladesh",
  "BE": "Belgium",
  "BF": "Burkina Faso",
  "BG": "Bulgaria",
  "BH": "Bahrain",
  "BI": "Burundi",
  "BJ": "Benin",
  "BL": "Saint Barthélemy",
  "BM": "Bermuda",
  "BN": "Brunei Darussalam",
  "BO": "Bolivia (Plurinational State of)",
  "BQ": "Bonaire, Sint Eustatius and Saba",
  "BR": "Brazil",
  "BS": "Bahamas",
  "BT": "Bhutan",
  "BV": "Bouvet Island",
  "BW": "Botswana",
  "BY": "Belarus",
  "BZ": "Belize",
  "CA": "Canada",
  "CC": "Cocos (Keeling) Islands",
  "CD": "Congo (Democratic Republic of the)",
  "CF": "Central African Republic",
  "CG": "Congo",
  "CH": "Switzerland",
  "CI": "Côte d'Ivoire",
  "CK": "Cook Islands",
  "CL": "Chile",
  "CM": "Cameroon",
  "CN": "China",
  "CO": "Colombia",
  "CR": "Costa Rica",
  "CU": "Cuba",
  "CV": "Cabo Verde",
  "CW": "Curaçao",
  "CX": "Christmas Island",
  "CY": "Cyprus",
  "CZ": "Czechia",
  "DE": "Germany",
  "DJ": "Djibouti",
  "DK": "Denmark",
  "DM": "Dominica",
  "DO": "Dominican Republic",
  "DZ": "Algeria",
  "EC": "Ecuador",
  "EE": "Estonia",
  "EG": "Egypt",
  "EH": "Western Sahara",
  "ER": "Eritrea",
  "ES": "Spain",
  "ET": "Ethiopia",
  "FI": "Finland",
  "FJ": "Fiji",
  "FM": "Micronesia (Federated States of)",
  "FO": "Faroe Islands",
  "FR": "France",
  "GA": "Gabon",
  "GB": "United Kingdom of Great Britain and Northern Ireland",
  "GD": "Grenada",
  "GE": "Georgia",
  "GF": "French Guiana",
  "GG": "Guernsey",
  "GH": "Ghana",
  "GI": "Gibraltar",
  "GL": "Greenland",
  "GM": "Gambia",
  "GN": "Guinea",
  "GP": "Guadeloupe",
  "GQ": "Equatorial Guinea",
  "GR": "Greece",
  "GT": "Guatemala",
  "GU": "Guam",
  "GW": "Guinea-Bissau",
  "GY": "Guyana",
  "HK": "Hong Kong",
  "HM": "Heard Island and McDonald Islands",
  "HN": "Honduras",
  "HR": "Croatia",
  "HT": "Haiti",
  "HU": "Hungary",
  "ID": "Indonesia",
  "IE": "Ireland",
  "IL": "Israel",
  "IM": "Isle of Man",
  "IN": "India",
  "IO": "British Indian Ocean Territory",
  "IQ": "Iraq",
  "IR": "Iran (Islamic Republic of)",
  "IS": "Iceland",
  "IT": "Italy",
  "JE": "Jersey",
  "JM": "Jamaica",
  "JO": "Jordan",
  "JP": "Japan",
  "KE": "Kenya",
  "KG": "Kyrgyzstan",
  "KH": "Cambodia",
  "KI": "Kiribati",
  "KM": "Comoros",
  "KN": "Saint Kitts and Nevis",
  "KP": "Korea (Democratic People's Republic of)",
  "KR": "Korea (Republic of)",
  "KW": "Kuwait",
  "KY": "Cayman Islands",
  "KZ": "Kazakhstan",
  "LA": "Lao People's Democratic Republic",
  "LB": "Lebanon",
  "LC": "Saint Lucia",
  "LI": "Liechtenstein",
  "LK": "Sri Lanka",
  "LR": "Liberia",
  "LS": "Lesotho",
  "LT": "Lithuania",
  "LU": "Luxembourg",
  "LV": "Latvia",
  "LY": "Libya",
  "MA": "Morocco",
  "MC": "Monaco",
  "MD": "Moldova (Republic of)",
  "ME": "Montenegro",
  "MF": "Saint Martin (French part)",
  "MG": "Madagascar",
  "MH": "Marshall Islands",
  "MK": "North Macedonia",
  "ML": "Mali",
  "MM": "Myanmar",
  "MN": "Mongolia",
  "MO": "Macao",
  "MP": "Northern Mariana Islands",
  "MQ": "Martinique",
  "MR": "Mauritania",
  "MS": "Montserrat",
  "MT": "Malta",
  "MU": "Mauritius",
  "MV": "Maldives",
  "MW": "Malawi",
  "MX": "Mexico",
  "MY": "Malaysia",
  "MZ": "Mozambique",
  "NA": "Namibia",
  "NC": "New Caledonia",
  "NE": "Niger",
  "NF": "Norfolk Island",
  "NG": "Nigeria",
  "NI": "Nicaragua",
  "NL": "Netherlands",
  "NO": "Norway",
  "NP": "Nepal",
  "NR": "Nauru",
  "NU": "Niue",
  "NZ": "New Zealand",
  "OM": "Oman",
  "PA": "Panama",
  "PE": "Peru",
  "PF": "French Polynesia",
  "PG": "Papua New Guinea",
  "PH": "Philippines",
  "PK": "Pakistan",
  "PL": "Poland",
  "PM": "Saint Pierre and Miquelon",
  "PN": "Pitcairn",
  "PR": "Puerto Rico",
  "PT": "Portugal",
  "PW": "Palau",
  "PY": "Paraguay",
  "QA": "Qatar",
  "RE": "Réunion",
  "RO": "Romania",
  "RS": "Serbia",
  "RU": "Russian Federation",
  "RW": "Rwanda",
  "SA": "Saudi Arabia",
  "SB": "Solomon Islands",
  "SC": "Seychelles",
  "SD": "Sudan",
  "SE": "Sweden",
  "SG": "Singapore",
  "SH": "Saint Helena, Ascension and Tristan da Cunha",
  "SI": "Slovenia",
  "SJ": "Svalbard and Jan Mayen",
  "SK": "Slovakia",
  "SL": "Sierra Leone",
  "SM": "San Marino",
  "SN": "Senegal",
  "SO": "Somalia",
  "SR": "Suriname",
  "SS": "South Sudan",
  "ST": "Sao Tome and Principe",
  "SV": "El Salvador",
  "SX": "Sint Maarten (Dutch part)",
  "SY": "Syrian Arab Republic",
  "SZ": "Eswatini",
  "TC": "Turks and Caicos Islands",
  "TD": "Chad",
  "TF": "French Southern Territories",
  "TG": "Togo",
  "TH": "Thailand",
  "TJ": "Tajikistan",
  "TK": "Tokelau",
  "TL": "Timor-Leste",
  "TM": "Turkmenistan",
  "TN": "Tunisia",
  "TO": "Tonga",
  "TR": "Türkiye",
  "TT": "Trinidad and Tobago",
  "TV": "Tuvalu",
  "TZ": "Tanzania, United Republic of",
  "UA": "Ukraine",
  "UG": "Uganda",
  "UM": "United States Minor Outlying Islands",
  "US": "United States of America",
  "UY": "Uruguay",
  "UZ": "Uzbekistan",
  "VA": "Holy See",
  "VC": "Saint Vincent and the Grenadines",
  "VE": "Venezuela (Bolivarian Republic of)",
  "VG": "Virgin Islands (British)",
  "VI": "Virgin Islands (U.S.)",
  "VN": "Viet Nam",
  "VU": "Vanuatu",
  "WF": "Wallis and Futuna",
  "WS": "Samoa",
  "YE": "Yemen",
  "ZA": "South Africa",
  "ZM": "Zambia",
  "ZW": "Zimbabwe"
};

const residentialMap = {
  "1": "Residential",
  "0": "Commercial"
};

const deliveryConfirmationMap = {
  "S": "Signature Required",
  "N": "Delivery Confirmation with No Signature",
  "A": "Adult Signature Required",
  "V": "Verbal Confirmation"
};

const ADLdeliverToAddresseeMap = {
  "0": "Option not requested", 
  "1": "Deliver To address only option requested"
};

const ADLmediaType = {
  "01": "Voice",
  "03": "Email",
  "12": "SMS Text"
};

const packagingMap = {
  "1": "UPS Letter/Envelope",
  "4": "UPS PAK",
  "3": "UPS Tube",
  "S": "UPS Express Box (Small)",
  "M": "UPS Express Box (Medium)",
  "L": "UPS Express Box (Large)",
  "21": "UPS Box",
  "25": "UPS 10 KG Box",
  "24": "UPS 25 KG Box",
  "2": "Other Packaging/Customer Packaging",
  "30": "Pallet (valid only for PL to PL)"
};

const serviceMap = {
  "01": "Next Day Air",
  "02": "2nd Day Air",
  "03": "Ground",
  "07": "International Express",
  "08": "International Expedited",
  "11": "International Standard",
  "12": "3 Day Select",
  "13": "Next Day Air Saver",
  "14": "Next Day Air Early",
  "54": "International Express Plus",
  "59": "2 Day Air A.M",
  "64": "UPS Express NA1",
  "65": "UPS Saver",
  "70": "UPS Access Point Economy",
  "74": "UPS Express 12:00",
  "82": "UPS Today Standard",
  "83": "UPS Today Dedicated Courier",
  "84": "UPS Today Intercity",
  "85": "UPS Today Express",
  "86": "UPS Today Express Saver",
  "92": "SurePost Standard Parcel (not supported)",
  "93": "SurePost Parcel Select",
  "94": "SurePost Bound Printed Matter",
  "95": "SurePost Media Mail"
};

function setupAutocomplete(inputId, suggestionsId, map) {
    const input = document.getElementById(inputId);
    const suggestionsBox = document.getElementById(suggestionsId);
    if (!input || !suggestionsBox) return;

    function renderSuggestions(query) {
      suggestionsBox.innerHTML = "";
      const matches = Object.entries(map)
        .filter(([code, name]) =>
          query === "" || code.startsWith(query) || name.toUpperCase().startsWith(query)
        )
        .slice(0, 25);

      if (matches.length === 0) {
        suggestionsBox.style.display = "none";
        return;
      }

      matches.forEach(([code, name]) => {
        const li = document.createElement("li");
        li.textContent = `${code} - ${name}`;
        li.addEventListener("click", () => {
          input.value = code;
          suggestionsBox.style.display = "none";
          if (typeof validateAllFields === "function") validateAllFields();
        });
        suggestionsBox.appendChild(li);
      });

      // Position the suggestions below the input field
      suggestionsBox.style.position = "absolute";
      suggestionsBox.style.top = `${input.offsetTop + input.offsetHeight}px`;
      suggestionsBox.style.left = "0";
      suggestionsBox.style.width = `${input.offsetWidth}px`;
      suggestionsBox.style.display = "block";
    }

    input.addEventListener("input", () => {
      const query = input.value.toUpperCase();
      renderSuggestions(query);
    });

    input.addEventListener("focus", () => {
      renderSuggestions("");
    });

    document.addEventListener("click", e => {
      if (!suggestionsBox.contains(e.target) && e.target !== input) {
        suggestionsBox.style.display = "none";
      }
    });
  }

  // Setup all autocompletes here
  setupAutocomplete("Country", "country-suggestions", countryMap);
  setupAutocomplete("Residential_Ind", "residential-suggestions", residentialMap);
  setupAutocomplete("Delivery_Confirm", "deliveryconfirm-suggestions", deliveryConfirmationMap);
  setupAutocomplete("Packaging_Type", "packaging-suggestions", packagingMap);
  setupAutocomplete("Service", "service-suggestions", serviceMap);
  setupAutocomplete("ADL_Deliver_to_Addressee", "adldeliveraddr-suggestions", ADLdeliverToAddresseeMap);

  setupAutocomplete("ADL_Deliver_to_Addressee", "adlmediatype-suggestions", ADLmediaType);
  setupAutocomplete("ADL_Shipper_Media_Type", "adlshippermediatype-suggestionss", ADLmediaType);

  // Toggle Advanced Fields (with scroll + remember state)
  const wrapper = document.getElementById("advanced-wrapper");
  const toggleBtn = document.getElementById("toggle-advanced");

  toggleBtn.addEventListener("click", () => {
    const isVisible = wrapper.classList.toggle("show");
    toggleBtn.textContent = isVisible ? "Hide Advanced Fields" : "Show Advanced Fields";
    localStorage.setItem("advancedVisible", isVisible);
    if (isVisible) wrapper.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  if (localStorage.getItem("advancedVisible") === "true") {
    wrapper.classList.add("show");
    toggleBtn.textContent = "Hide Advanced Fields";
  }
});

</script>
<ul id="country-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="packaging-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="service-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="deliveryconfirm-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="residential-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="adldeliveraddr-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="adlmediatype-suggestions" class="autocomplete-list" style="display: none;"></ul>
<ul id="adlshippermediatype-suggestionss" class="autocomplete-list" style="display: none;"></ul>
</body>
</html>
